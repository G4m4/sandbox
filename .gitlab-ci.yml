# As seen on https://gitlab.com/gitlab-examples/cpp-example/-/blob/master/.gitlab-ci.yml

stages:
  - lint
  - build
  - test
  # - deploy

lint:linux:
  stage: lint
  image: xianpengshen/clang-tools:18
  script:
    - find ./sandbox -type f -name '*.cpp' -o -name '*.cc' -exec clang-tidy --config-file=.clang-tidy {} -- -I. \; | tee clang-tidy.log
    # Fail the job if errors were found:
    - ! grep "warning" clang-tidy.log
  rules:
    # Executing for every commit on the main branch where C++ files were modified:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "master"
      # changes:
      #   - "*.cpp"
      #   - "**/*.cpp"
  artifacts:
    expire_in: 2 days
    paths:
      - clang-tidy.log

build:linux:
  stage: build
  image: gcc
  # tags:
  #   - linux
  before_script:
    - apt update && apt -y install make autoconf cmake
  script:
    - mkdir build
    - cd build
    - cmake ..
    - make
  artifacts:
    expire_in: 2 hrs
    paths:
      - build/

# build:windows:
#   stage: build
#   tags:
#     - windows
#   script:
#     - mkdir build
#     - cd build
#     - '"C:\Program Files\CMake\bin\cmake.exe" -G "Visual Studio 15 2017 Win64" -DBUILD_LIBTIFF=ON ..'
#     - '"C:\Program Files\CMake\bin\cmake.exe" ..'
#     - '"C:\Program Files\CMake\bin\cmake.exe" --build . --config Release --target ALL_BUILD'
#   artifacts:
#     expire_in: 2 hrs
#     paths:
#       - build/

# Run unit test
test:linux:
  stage: test
  image: gcc
  # tags:
  #   - linux
  script:
    - ./build/sandbox/implementation/standalone/sandbox
  dependencies:
    - build:linux

# # Build and Push Docker Image
# build:docker:
#   stage: deploy
#   when: on_success
#   only:
#     - master
#   image: docker:stable
#   services:
#     - docker:dind
#   script:
#     - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
#     - docker build -t $CI_REGISTRY_IMAGE .
#     - docker push $CI_REGISTRY_IMAGE
#   dependencies:
#     - build:linux
